<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Job Description Simplifier v0.11</title>
  <meta name="color-scheme" content="light dark" />
  <!-- Google OAuth client ID -->
  <meta name="google-oauth-client-id"
        content="105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root {
      --bg:#0f172a; --card:#020617; --panel:#020617; --border:#1e293b;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --accent-soft:rgba(56,189,248,0.12);
      --danger:#ef4444; --ok:#22c55e;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:#f8fafc; --card:#ffffff; --panel:#ffffff; --border:#e5e7eb;
        --text:#020617; --muted:#475569; --accent:#0ea5e9; --accent-soft:rgba(14,165,233,0.10);
        --danger:#b91c1c; --ok:#16a34a;
      }
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body {
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 600px at 5% 0%, rgba(56,189,248,0.10), transparent 55%),
        radial-gradient(800px 600px at 95% 0%, rgba(129,140,248,0.12), transparent 50%),
        var(--bg);
      color:var(--text);
    }
    .wrap {
      max-width: 1000px;
      margin:0 auto;
      padding:18px 16px 26px;
    }
    .card {
      background:var(--card);
      border-radius:20px;
      border:1px solid var(--border);
      padding:18px 18px 20px;
      box-shadow:0 18px 40px rgba(15,23,42,0.45);
    }
    h1 {
      margin:0;
      font-size:24px;
      letter-spacing:.02em;
      display:flex;
      align-items:baseline;
      gap:8px;
    }
    .version-tag {
      font-size:11px;
      font-weight:600;
      color:var(--muted);
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      cursor:pointer;
      transition:background .12s ease, border-color .12s ease, color .12s ease, box-shadow .12s ease, transform .06s ease;
    }
    .version-tag:hover {
      border-color:var(--accent);
      color:var(--accent);
      background:var(--accent-soft);
      box-shadow:0 4px 10px rgba(15,23,42,0.4);
      transform:translateY(-0.5px);
    }
    .version-tag:focus-visible {
      outline:2px solid var(--accent);
      outline-offset:2px;
    }
    .muted { color:var(--muted); font-size:14px; }

    .pill-btn {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:transparent;
      cursor:pointer;
      text-decoration:none;
      transition:background .12s ease, border-color .12s ease, color .12s ease, box-shadow .12s ease, transform .06s ease;
    }
    .pill-btn:hover {
      border-color:var(--accent);
      color:var(--accent);
      background:var(--accent-soft);
      box-shadow:0 4px 10px rgba(15,23,42,0.4);
      transform:translateY(-0.5px);
    }
    .pill-btn:focus-visible {
      outline:2px solid var(--accent);
      outline-offset:2px;
    }

    .section {
      margin-top:14px;
      padding:12px;
      border-radius:12px;
      background:rgba(15,23,42,0.65);
      border:1px dashed var(--border);
    }
    @media (prefers-color-scheme: light) {
      .section { background:#f9fafb; }
    }
    .section-title {
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:6px;
    }
    label {
      font-size:13px;
      font-weight:600;
      margin-bottom:4px;
      display:block;
    }
    input, select, textarea {
      width:100%;
      font-size:14px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
    }
    textarea { resize:vertical; min-height:80px; }
    input::placeholder, textarea::placeholder { color:var(--muted); }

    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
    }
    .btn-row { display:flex;flex-wrap:wrap;gap:8px;margin-top:8px; }
    button {
      border-radius:999px;
      border:1px solid var(--border);
      padding:8px 13px;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:var(--panel);
      color:var(--text);
      cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    button.primary {
      border-color:var(--accent);
      background:linear-gradient(180deg,var(--accent-soft),transparent);
    }
    button:hover {
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,0.5);
    }

    .small-note { font-size:11px;color:var(--muted);margin-top:3px; }
    #status, #aiStatus { font-size:12px;color:var(--muted);margin-top:4px; }
    .danger { color:var(--danger); }
    .ok { color:var(--ok); }

    /* legacy summary styling overridden by shared details styles */
    details.debug-panel summary,
    details.advanced summary {
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    #debugOutput {
      margin-top:6px;
      max-height:220px;
      overflow:auto;
      background:var(--panel);
      border-radius:10px;
      border:1px solid var(--border);
      padding:6px;
      font-size:11px;
      white-space:pre-wrap;
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* ============================
       AVD DETAILS (shared invariant)
       - dashed border + padded container
       - closed by default (enforced in JS)
       - consistent caret marker + rotate on open
       - highlight when open
       - nested details inherit automatically
       ============================ */

    details {
      margin-top:10px;
      border-radius:12px;
      border:1px dashed var(--border);
      padding:8px 10px;
      background:rgba(15,23,42,0.40);
    }
    @media (prefers-color-scheme: light) {
      details { background:#f3f4f6; }
    }

    details > summary {
      list-style:none;
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      outline:none;
    }
    /* Remove native marker so our caret is consistent cross-browser */
    details > summary::-webkit-details-marker { display:none; }
    details > summary::marker { content:""; }

    /* Caret marker */
    details > summary::before {
      content:"▸";
      display:inline-block;
      transform:rotate(0deg);
      transition:transform .12s ease;
      opacity:0.9;
    }
    details[open] > summary::before { transform:rotate(90deg); }

    /* Open highlight */
    details[open] {
      border-color:var(--accent);
      background:rgba(56,189,248,0.08);
      box-shadow:0 6px 18px rgba(15,23,42,0.25);
    }
    @media (prefers-color-scheme: light) {
      details[open] { background:rgba(14,165,233,0.08); }
    }
    details[open] > summary {
      color:var(--text);
    }

    /* Keep debug panel inner pre consistent */
    details.debug-panel pre { margin-top:6px; }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;">
        <div>
          <h1>
            Job Description Simplifier
            <button id="copyVersionBtn" class="version-tag" type="button"
                    title="Copy full index.html to clipboard"
                    aria-label="Copy full index.html to clipboard">v0.11</button>
          </h1>
          <div class="muted">
            Pick an event or paste text, then get a shorter, clearer description that doesn’t lose critical details.
          </div>
        </div>
        <button class="pill-btn" type="button"
                onclick="window.location.href='https://frazerboorman.github.io/';">
          Frazer · AVD Tools
        </button>
      </div>

      <!-- STEP 1 – Calendar selection -->
      <div class="section">
        <div class="section-title">Step 1 – Load events from Google Calendar</div>
        <div class="grid">
          <div>
            <label for="eventSelect">Events</label>
            <select id="eventSelect">
              <option value="">Sign in to load events…</option>
            </select>
            <div id="status">Status: Waiting for sign-in…</div>
            <div id="aiStatus"></div>
          </div>
          <div style="align-self:end;">
            <button id="signinBtn" class="primary" type="button">Sign into Google</button>
            <div class="small-note">
              Same OAuth flow pattern as the other AVD tools.
            </div>
          </div>
        </div>

        <details class="advanced" style="margin-top:10px;">
          <summary>Advanced date range</summary>
          <div class="grid" style="margin-top:8px;">
            <div>
              <label for="advancedStartDate">Start date</label>
              <input id="advancedStartDate" type="date" />
              <div class="small-note">Defaults to 14 days ago.</div>
            </div>
            <div>
              <label for="advancedEndDate">End date</label>
              <input id="advancedEndDate" type="date" />
              <div class="small-note">Defaults to 14 days ahead (future events included).</div>
            </div>
          </div>
          <div class="btn-row" style="margin-top:8px;">
            <button id="applyRangeBtn" type="button">Apply date range</button>
            <div class="small-note">Loads events inside this range (future events included).</div>
          </div>
        </details>
      </div>

      <!-- STEP 2 – Original text -->
      <div class="section">
        <div class="section-title">Step 2 – Original job description</div>
        <div class="grid">
          <div>
            <label for="originalTitle">Title</label>
            <input id="originalTitle" placeholder="Event title will appear here (or type manually)"/>
          </div>
        </div>
        <div style="margin-top:8px;">
          <label for="originalText">Full description / notes</label>
          <textarea id="originalText"
            placeholder="Event description will appear here, including any database dump, access notes, kit details, etc. You can also paste text manually."></textarea>
          <div class="small-note">
            If you don’t pick an event, you can just paste whatever text you want simplified.
          </div>
        </div>
      </div>

      <!-- STEP 3 – Simplify -->
      <div class="section">
        <div class="section-title">Step 3 – Simplify (without losing important details)</div>
        <div class="btn-row">
          <button id="simplifyBtn" class="primary" type="button">Simplify description</button>
          <button id="copyBtn" type="button">Copy simplified text</button>
        </div>
        <div class="small-note">
          Uses the OpenAI key saved below. You only need to set it once per device.
        </div>

        <div style="margin-top:10px;">
          <label for="simplifiedText">Simplified description</label>
          <textarea id="simplifiedText"
            placeholder="AI output will appear here. You can tweak it before copying into the calendar."></textarea>
        </div>
      </div>

      <!-- ADVANCED – API & Calendar settings -->
      <div class="section">
        <details class="advanced">
          <summary>API & Calendar settings (advanced)</summary>
          <div style="margin-top:6px;">
            <div class="grid">
              <div>
                <label for="apiKeyInput">OpenAI API key</label>
                <input id="apiKeyInput" type="password" autocomplete="off" placeholder="sk-..." />
                <div class="small-note">
                  Stored only in this browser via <code>localStorage['avd_job_report_openai_key']</code>.
                </div>
              </div>

              <div>
                <label for="modelSelect">Preferred model (optional)</label>
                <select id="modelSelect"></select>
                <div class="small-note">
                  Uses model candidates + automatic fallback if a model fails.
                </div>
              </div>

              <div>
                <label for="calendarId">Calendar ID</label>
                <input id="calendarId"
                  value="bb14db72acb2ffd4230316960d02103fa66e54901522ff7b8113eec682f6d42e@group.calendar.google.com" />
                <div class="small-note">
                  Calendar used when loading events (same as your other tools).
                </div>
              </div>
            </div>

            <div class="btn-row">
              <button id="saveKeyBtn" type="button">Save key</button>
              <button id="clearKeyBtn" type="button">Clear key</button>
              <button id="testOpenAiBtn" class="primary" type="button">Test OpenAI call</button>
            </div>
            <div id="apiKeyStatus" class="small-note"></div>
          </div>
        </details>
      </div>

      <!-- DEBUG PANEL -->
      <div class="section">
        <details class="debug-panel">
          <summary>Debug log (errors / API responses)</summary>
          <pre id="debugOutput">Debug log initialised…</pre>
        </details>
      </div>
    </div>
  </div>

  <script>

    /*
      ============================================================
      AVD JOB-SIMP — TOOL CONSTITUTION + GUARD RAILS (CODEX ONLY)
      ============================================================

      TOOL_CODE: JOB-SIMP
      TOOL_NAME: Job Description Simplifier
      VERSION: v0.11
      LAST_UPDATED: 2025-12-21

      CODEX POINTERS:
      - Root: /CODEX.md (front door: shared invariants + do/don't)
      - Tool manual: /context/JOB-SIMP.md (full behaviour, regression checks)

      Purpose:
      - Pull a Calendar event (title + full description/notes + location) or accept pasted text,
        then simplify it without losing operational detail.

      Non-negotiables / invariants:
      1) Calendar selection must populate:
         - Title -> #originalTitle
         - Full description/notes -> #originalText
         - Location appended if present
         - If description is missing from events.list payload, tool must fetch full event via events.get.

      2) Do not filter out future events.
      3) Advanced date range includes future end date by default.
      4) Shared OpenAI key storage:
         - localStorage['avd_job_report_openai_key'] must remain stable.

      Safe edits:
      - No refactor that changes IDs, storage key names, or model fallback semantics unless explicitly required.
    */

    // =========================
    // TOOL METADATA
    // =========================
    const TOOL_NAME = "Job Description Simplifier";
    const TOOL_VERSION = "v0.11";
    const TOOL_LAST_UPDATED = "2025-12-21";
    const TOOL_CODE = "JOB-SIMP";


    // =========================
    // GOOGLE CALENDAR
    // =========================
    const CLIENT_ID = "105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com";
    const SCOPES   = "https://www.googleapis.com/auth/calendar.readonly";

    // =========================
    // OPENAI (shared across AVD tools)
    // =========================
    const OPENAI_KEY_STORAGE = "avd_job_report_openai_key";
    const OPENAI_MODEL_CANDIDATES = [
      "gpt-5.2",
      "gpt-5.2-mini",
      "gpt-5.2-nano",
      "gpt-4.1",
      "gpt-4.1-mini"
    ];

    let tokenClient = null;
    let accessToken = null;
    let currentEvents = [];

    function debugLog(msg, data) {
      const el = document.getElementById("debugOutput");
      if (!el) return;
      const ts = new Date().toISOString();
      let line = "[" + ts + "] " + msg;
      if (data !== undefined) {
        try { line += " " + JSON.stringify(data); }
        catch { line += " " + String(data); }
      }
      el.textContent += "
" + line;
      el.scrollTop = el.scrollHeight;
    }

    function setStatus(msg, isError) {
      const el = document.getElementById("status");
      if (!el) return;
      el.textContent = "Status: " + msg;
      el.className = isError ? "danger" : "";
      debugLog("STATUS: " + msg + (isError ? " [ERROR]" : ""));
    }
    function setAiStatus(msg, isError) {
      const el = document.getElementById("aiStatus");
      if (!el) return;
      el.textContent = msg || "";
      el.className = isError ? "danger" : "";
      if (msg) debugLog("AI: " + msg + (isError ? " [ERROR]" : ""));
    }

    function setApiKeyStatus(msg, isError) {
      const el = document.getElementById("apiKeyStatus");
      if (!el) return;
      el.textContent = msg || "";
      el.className = "small-note " + (isError ? "danger" : "");
      if (msg) debugLog("APIKEY: " + msg + (isError ? " [ERROR]" : ""));
    }

    function initModelDropdown() {
      const sel = document.getElementById("modelSelect");
      if (!sel) return;
      sel.innerHTML = "";
      for (const m of OPENAI_MODEL_CANDIDATES) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        sel.appendChild(opt);
      }
      sel.value = OPENAI_MODEL_CANDIDATES[0];
    }

    function getPreferredModel() {
      const sel = document.getElementById("modelSelect");
      return (sel && sel.value) ? sel.value : OPENAI_MODEL_CANDIDATES[0];
    }

    // -------------------------
    // DATE RANGE (future included)
    // -------------------------
    function getDateRangeOrDefault() {
      const startInput = document.getElementById("advancedStartDate");
      const endInput = document.getElementById("advancedEndDate");

      const now = new Date();
      const defaultStart = new Date(now);
      defaultStart.setDate(defaultStart.getDate() - 14);
      defaultStart.setHours(0,0,0,0);

      const defaultEnd = new Date(now);
      defaultEnd.setDate(defaultEnd.getDate() + 14);
      defaultEnd.setHours(23,59,59,999);

      const start = startInput?.value ? new Date(startInput.value + "T00:00:00") : defaultStart;
      const end   = endInput?.value ? new Date(endInput.value + "T23:59:59.999") : defaultEnd;

      if (isNaN(start.getTime()) || isNaN(end.getTime())) {
        setStatus("Invalid date range. Please use valid dates.", true);
        return null;
      }
      if (start > end) {
        setStatus("Start date must be on or before the end date.", true);
        return null;
      }
      return { start, end };
    }

    function setDefaultDateRangeInputs() {
      const startInput = document.getElementById("advancedStartDate");
      const endInput = document.getElementById("advancedEndDate");
      const now = new Date();

      const start = new Date(now);
      start.setDate(start.getDate() - 14);

      const end = new Date(now);
      end.setDate(end.getDate() + 14);

      if (startInput && !startInput.value) startInput.value = start.toISOString().slice(0, 10);
      if (endInput && !endInput.value) endInput.value = end.toISOString().slice(0, 10);
    }

    // -------------------------
    // Calendar helpers
    // -------------------------
    function getEventStartDate(ev) {
      if (!ev || !ev.start) return null;
      if (ev.start.date) return new Date(ev.start.date + "T00:00:00Z");
      if (ev.start.dateTime) return new Date(ev.start.dateTime);
      return null;
    }
    function extractEventDate(ev) {
      if (!ev || !ev.start) return "";
      if (ev.start.date) return ev.start.date;
      if (ev.start.dateTime) return ev.start.dateTime.slice(0,10);
      return "";
    }

    function initAuth() {
      debugLog("Initialising Google auth…");
      if (!window.google || !google.accounts || !google.accounts.oauth2) {
        debugLog("Google accounts OAuth2 not available yet.");
        return;
      }
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        prompt: "",
        callback: (resp) => {
          debugLog("Google OAuth callback received", resp);
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            setStatus("Signed in. Loading events…", false);
            loadEventsInRange();
          } else {
            setStatus("Sign-in failed.", true);
          }
        }
      });
    }

    function signInManual() {
      debugLog("Sign-in button clicked.");
      if (!tokenClient) initAuth();
      if (!tokenClient) {
        setStatus("Google auth not ready.", true);
        return;
      }
      tokenClient.requestAccessToken();
    }

    async function loadEventsInRange() {
      if (!accessToken) {
        setStatus("No access token yet.", true);
        return;
      }
      const range = getDateRangeOrDefault();
      if (!range) return;

      const { start, end } = range;
      const calId = (document.getElementById("calendarId").value || "primary").trim();

      debugLog("Loading events for calendar", { calendar: calId, start: start.toISOString(), end: end.toISOString() });

      const url = new URL(
        "https://www.googleapis.com/calendar/v3/calendars/" +
        encodeURIComponent(calId) +
        "/events"
      );
      url.searchParams.set("singleEvents","true");
      url.searchParams.set("orderBy","startTime");
      url.searchParams.set("timeMin", start.toISOString());
      url.searchParams.set("timeMax", end.toISOString());
      url.searchParams.set("maxResults","250");

      try {
        const res = await fetch(url.toString(), { headers: { "Authorization":"Bearer " + accessToken } });
        debugLog("Calendar fetch response status", res.status);
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          debugLog("Calendar fetch error body", txt);
          setStatus("Calendar API error " + res.status, true);
          return;
        }

        const data = await res.json();
        const items = data.items || [];
        debugLog("Calendar events raw", { count: items.length });

        // IMPORTANT: do NOT filter out future events.
        const processed = items
          .map(ev => ({ ev, startDate: getEventStartDate(ev) }))
          .filter(obj => obj.startDate)
          .sort((a,b) => a.startDate - b.startDate);

        currentEvents = processed.map(x => x.ev);

        const sel = document.getElementById("eventSelect");
        sel.innerHTML = "";

        if (!currentEvents.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No events in selected range.";
          sel.appendChild(opt);
          setStatus("No events found in that range.", false);
          return;
        }

        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "— Select event —";
        sel.appendChild(placeholder);

        currentEvents.forEach((ev, idx) => {
          const title = ev.summary || "(no title)";
          const d = extractEventDate(ev);
          const opt = document.createElement("option");
          opt.value = String(idx);
          opt.textContent = (d ? (d + " – ") : "") + title;
          sel.appendChild(opt);
        });

        setStatus("Loaded " + currentEvents.length + " events.", false);
      } catch (e) {
        console.error(e);
        debugLog("Error loading events", { error: e.message || String(e) });
        setStatus("Error loading events: " + (e.message || String(e)), true);
      }
    }


    async function fetchEventDetails(eventId) {
      if (!accessToken) throw new Error("No access token yet.");
      const calId = (document.getElementById("calendarId").value || "primary").trim();
      const url = new URL(
        "https://www.googleapis.com/calendar/v3/calendars/" +
        encodeURIComponent(calId) +
        "/events/" + encodeURIComponent(eventId)
      );

      // Ask explicitly for fields we care about (defensive against partial payloads)
      url.searchParams.set("fields", "id,summary,description,location,start,end");

      debugLog("Fetching full event via events.get", { eventId, url: url.toString() });

      const res = await fetch(url.toString(), { headers: { "Authorization":"Bearer " + accessToken } });
      debugLog("events.get response status", res.status);

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        debugLog("events.get error body (truncated)", txt.slice(0, 500));
        throw new Error("Calendar events.get error " + res.status);
      }
      return await res.json();
    }


    async function fillFromSelectedEvent() {
      const sel = document.getElementById("eventSelect");
      if (!sel.value) return;
      const ev0 = currentEvents[Number(sel.value)];
      if (!ev0) return;

      let ev = ev0;

      // If description isn't present in the list payload, fetch the full event.
      // This fixes cases where list responses are partial (or tooling later adds a fields= filter).
      const needsFetch = (!ev.description || !String(ev.description).trim()) && ev.id;
      if (needsFetch) {
        try {
          ev = await fetchEventDetails(ev.id);
          // update cache so subsequent selects are instant
          currentEvents[Number(sel.value)] = ev;
        } catch (e) {
          debugLog("events.get failed; continuing with list payload", { error: e.message || String(e) });
        }
      }

      debugLog("Event selected", { title: ev.summary || "", id: ev.id, hasDescription: !!(ev.description && String(ev.description).trim()) });

      document.getElementById("originalTitle").value = ev.summary || "";

      const bits = [];
      if (ev.description && String(ev.description).trim()) bits.push(ev.description);
      if (ev.location && String(ev.location).trim()) bits.push("Location: " + ev.location);

      document.getElementById("originalText").value = bits.length ? bits.join("\n\n") : "";

      setStatus("Loaded event details into original fields.", false);
    }

    // -------------------------
    // OpenAI helpers (Responses API + fallbacks)
    // -------------------------
    function getOpenAIKeyOrThrow() {
      const key = localStorage.getItem(OPENAI_KEY_STORAGE);
      if (!key) {
        debugLog("OpenAI key missing in localStorage", OPENAI_KEY_STORAGE);
        throw new Error("No OpenAI API key found. Save it in the advanced settings.");
      }
      return key;
    }

    async function callOpenAIWithFallback(systemPrompt, userPrompt) {
      const apiKey = getOpenAIKeyOrThrow();

      const models = [];
      const preferred = getPreferredModel();
      if (preferred) models.push(preferred);
      for (const m of OPENAI_MODEL_CANDIDATES) if (!models.includes(m)) models.push(m);

      let lastErr = null;

      for (const model of models) {
        try {
          debugLog("OpenAI attempt", { model });

          const res = await fetch("https://api.openai.com/v1/responses", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + apiKey
            },
            body: JSON.stringify({
              model,
              input: [
                { role: "system", content: systemPrompt },
                { role: "user", content: userPrompt }
              ]
            })
          });

          debugLog("OpenAI response status", { model, status: res.status });

          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            lastErr = new Error("OpenAI " + res.status + " (" + model + "): " + txt.slice(0, 300));
            debugLog("OpenAI error body (truncated)", { model, body: txt.slice(0, 500) });
            continue;
          }

          const data = await res.json();

          let outText = "";
          if (data && data.output && data.output[0] && data.output[0].content && data.output[0].content[0]) {
            outText = data.output[0].content[0].text || "";
          }

          if (!outText) {
            lastErr = new Error("OpenAI returned empty content (" + model + ").");
            debugLog("OpenAI empty content", { model });
            continue;
          }

          return { modelUsed: model, text: outText };
        } catch (e) {
          lastErr = e;
          debugLog("OpenAI exception", { model, error: e.message || String(e) });
        }
      }

      throw lastErr || new Error("OpenAI call failed.");
    }

    async function testOpenAiCall() {
      try {
        setAiStatus("Testing OpenAI…", false);
        const system = "Reply with a single short sentence. No extra text.";
        const user = "Say: OpenAI is connected.";
        const result = await callOpenAIWithFallback(system, user);
        setAiStatus("OpenAI OK (" + result.modelUsed + "): " + result.text, false);
      } catch (e) {
        setAiStatus("OpenAI test failed: " + (e.message || String(e)), true);
      }
    }

    async function simplifyDescription() {
      const title = (document.getElementById("originalTitle").value || "").trim();
      const text  = (document.getElementById("originalText").value || "").trim();

      if (!title && !text) {
        setAiStatus("Nothing to simplify. Select an event or paste text first.", true);
        return;
      }

      const combined = "Title: " + title + "

Details:
" + text;
      debugLog("Simplify called", { titleLength: title.length, textLength: text.length });

      document.getElementById("simplifyBtn").disabled = true;
      setAiStatus("Talking to OpenAI…", false);

      try {
        const systemPrompt =
          "You are simplifying an AV job/event description for an engineer who will read it quickly on their phone.

" +
          "GOAL:
" +
          "- Rewrite the description so it is shorter, clearer and easier to scan.
" +
          "- KEEP all important factual details: locations, building names, dates, key constraints, key people, kit names,
" +
          "  special requirements, access instructions, and any unusual caveats.
" +
          "- Remove waffle, repetition, and internal admin noise that doesn’t help someone understand what they’re doing that day.

" +
          "Rules:
" +
          "- Do NOT invent anything that is not clearly implied by the original text.
" +
          "- Do NOT drop important instructions just because they sound boring.
" +
          "- It’s fine to reorder information to improve clarity.
" +
          "- The output should be suitable for dropping straight into the calendar description.

" +
          "Output:
" +
          "- 1–3 short paragraphs and/or a few bullet points.
" +
          "- Do NOT add labels like 'Summary:' – just the cleaned-up text.";

        const result = await callOpenAIWithFallback(systemPrompt, combined);

        document.getElementById("simplifiedText").value = result.text;
        setAiStatus("Simplified description ready (" + result.modelUsed + "). Review and tweak if needed.", false);
      } catch (e) {
        console.error("Simplify error:", e);
        debugLog("Simplify error", { error: e.message || String(e) });
        setAiStatus(e.message || "Error simplifying description.", true);
      } finally {
        document.getElementById("simplifyBtn").disabled = false;
      }
    }

    async function copySimplified() {
      const txt = (document.getElementById("simplifiedText").value || "").trim();
      if (!txt) { alert("No simplified text to copy yet."); return; }
      try {
        await navigator.clipboard.writeText(txt);
        alert("Simplified text copied to clipboard.");
        debugLog("Simplified text copied to clipboard.");
      } catch (e) {
        debugLog("Clipboard copy failed", { error: e.message || String(e) });
        alert("Could not copy automatically. You may need to select and copy manually.");
      }
    }

    async function getIndexHtmlSource() {
      const request = new Request("index.html", { cache: "no-cache" });
      try {
        const res = await fetch(request);
        if (!res.ok) throw new Error("Failed to fetch index.html (" + res.status + ")");
        return await res.text();
      } catch (e) {
        const dt = document.doctype;
        const doctype = dt
          ? "<!DOCTYPE " + dt.name + (dt.publicId ? " PUBLIC \"" + dt.publicId + "\"" : "") +
            (dt.systemId ? " \"" + dt.systemId + "\"" : "") + ">\n"
          : "<!DOCTYPE html>\n";
        return doctype + document.documentElement.outerHTML;
      }
    }

    async function copyFullPageHtml() {
      const htmlString = await getIndexHtmlSource();
      try {
        if (navigator.clipboard && typeof ClipboardItem !== "undefined" && navigator.clipboard.write) {
          const plainBlob = new Blob([htmlString], { type: "text/plain" });
          const htmlBlob  = new Blob([htmlString], { type: "text/html" });
          await navigator.clipboard.write([ new ClipboardItem({ "text/plain": plainBlob, "text/html": htmlBlob }) ]);
        } else if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(htmlString);
        } else {
          throw new Error("Clipboard API unavailable");
        }
        alert("Full index.html copied to clipboard.");
        return;
      } catch (e) {
        const helper = document.createElement("textarea");
        helper.value = htmlString;
        helper.setAttribute("aria-hidden", "true");
        helper.setAttribute("readonly", "true");
        helper.style.position = "fixed";
        helper.style.left = "-9999px";
        helper.style.top = "0";
        helper.style.opacity = "0";
        helper.style.pointerEvents = "none";
        document.body.appendChild(helper);

        let fallbackSuccess = false;
        try {
          helper.focus({ preventScroll: true });
          helper.select();
          helper.setSelectionRange(0, helper.value.length);
          fallbackSuccess = !!(document.execCommand && document.execCommand("copy"));
        } finally {
          document.body.removeChild(helper);
        }

        if (fallbackSuccess) { alert("Full index.html copied to clipboard."); return; }
        alert("Could not copy the full page automatically. You may need to copy manually.");
      }
    }

    function loadStoredApiKey() {
      const key = localStorage.getItem(OPENAI_KEY_STORAGE);
      const input = document.getElementById("apiKeyInput");
      if (key && input) {
        input.value = key;
        setApiKeyStatus("API key loaded from local storage.", false);
      } else {
        setApiKeyStatus("No API key saved yet.", false);
      }
    }

    function saveApiKey() {
      const input = document.getElementById("apiKeyInput");
      if (!input) return;
      const val = (input.value || "").trim();
      if (!val) { setApiKeyStatus("Cannot save an empty key.", true); return; }
      localStorage.setItem(OPENAI_KEY_STORAGE, val);
      setApiKeyStatus("API key saved to local storage.", false);
    }

    function clearApiKey() {
      localStorage.removeItem(OPENAI_KEY_STORAGE);
      const input = document.getElementById("apiKeyInput");
      if (input) input.value = "";
      setApiKeyStatus("API key cleared from local storage.", false);
    }

    window.addEventListener("DOMContentLoaded", () => {

      // Shared invariant: details panels closed by default on refresh
      document.querySelectorAll("details").forEach(d => { d.open = false; });

      // Ensure version pill text matches
      const versionBtn = document.getElementById("copyVersionBtn");
      if (versionBtn) versionBtn.textContent = TOOL_VERSION;

      initModelDropdown();

      document.getElementById("signinBtn").addEventListener("click", signInManual);
      document.getElementById("simplifyBtn").addEventListener("click", simplifyDescription);
      document.getElementById("copyBtn").addEventListener("click", copySimplified);
      document.getElementById("copyVersionBtn").addEventListener("click", copyFullPageHtml);
      document.getElementById("eventSelect").addEventListener("change", () => { fillFromSelectedEvent(); });

      document.getElementById("saveKeyBtn").addEventListener("click", saveApiKey);
      document.getElementById("clearKeyBtn").addEventListener("click", clearApiKey);
      document.getElementById("testOpenAiBtn").addEventListener("click", testOpenAiCall);

      document.getElementById("applyRangeBtn").addEventListener("click", () => {
        setStatus("Loading events with custom range…", false);
        loadEventsInRange();
      });

      setStatus("Waiting for sign-in…", false);
      debugLog("Page loaded, initialising auth soon…");
      loadStoredApiKey();
      setDefaultDateRangeInputs();
      setTimeout(() => { try { initAuth(); } catch(e){ debugLog("initAuth threw", { error: e.message || String(e) }); } }, 0);
    });
  </script>
</body>
</html>
